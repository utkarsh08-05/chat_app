{% extends "layout.html" %}

{% block content %}
<h4>
  Chat with {{ other_user.username }}
  <span id="status-dot" style="font-size:14px; margin-left:8px;"></span>
</h4>

<div id="chat-box" class="border p-3 mb-3" style="height:400px; overflow-y:auto;">
  <p class="text-muted">Loading messages...</p>
</div>

<form method="post">
  {% csrf_token %}
  <div class="input-group">
    <input type="text" name="content" class="form-control" placeholder="Type a message" required>
    <button class="btn btn-primary">Send</button>
  </div>
</form>

<script>
const chatBox = document.getElementById("chat-box");
const statusDot = document.getElementById("status-dot");

const messagesUrl = "{% url 'fetch_message' other_user.id %}";
const statusUrl   = "{% url 'user_status' other_user.id %}";
const currentUser = "{{ request.user.username }}";

// -------- Messages --------
function loadMessages() {
    fetch(messagesUrl, { cache: "no-store" })
        .then(res => res.json())
        .then(data => {
            chatBox.innerHTML = "";
            data.messages.forEach(msg => {
                const sender = msg.sender === currentUser ? "You" : msg.sender;
                chatBox.innerHTML += `
                    <div class="mb-2">
                        <b>${sender}</b>: ${msg.content}
                        <small class="text-muted">${msg.timestamp}</small>
                    </div>
                `;
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        });
}

// -------- Status --------
function loadStatus() {
    fetch(statusUrl, { cache: "no-store" })
        .then(res => res.json())
        .then(data => {
            statusDot.innerHTML = data.online ? "● Online" : "● Offline";
            statusDot.style.color = data.online ? "green" : "gray";
        });
}

setInterval(loadMessages, 2000);
setInterval(loadStatus, 3000);

loadMessages();
loadStatus();
</script>
{% endblock %}
